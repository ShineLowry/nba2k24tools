<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表格数据对比工具</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 30px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }
        
        .section-title {
            color: #2196f3;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 18px;
        }
        
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #1976d2;
        }
        
        .btn-success {
            background-color: #4caf50;
        }
        
        .btn-success:hover {
            background-color: #388e3c;
        }
        
        .result-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #4caf50;
            border-radius: 6px;
            background-color: #f1f8e9;
        }
        
        .result-title {
            color: #388e3c;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-box {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-title {
            color: #1976d2;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .comparison-summary {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>表格数据对比和修改记录提取</h1>
        
        <div class="info-box">
            <div class="info-title">核心逻辑说明</div>
            <p>1. 初始化时获取表格数据，生成初始列表</p>
            <p>2. 用户编辑完成后获取表格数据，生成最终列表</p>
            <p>3. 对比两个列表，找出所有修改的字段</p>
            <p>4. 提取修改记录，生成符合数据库log表结构的列表</p>
        </div>
        
        <div class="section">
            <div class="section-title">步骤1：模拟数据（实际从表格获取）</div>
            <p>假设的表格数据结构：每行包含id（No）和字段A-E</p>
            <div class="code-block" id="initialDataDisplay">
                // 初始数据列表
            </div>
            <div class="code-block" id="finalDataDisplay">
                // 最终数据列表
            </div>
            <button class="btn" onclick="generateTestData()">生成测试数据</button>
        </div>
        
        <div class="section">
            <div class="section-title">步骤2：核心对比函数</div>
            <p>这是最关键的部分：对比两个数据列表，提取修改记录</p>
            <div class="code-block">
/**
 * 对比初始数据和最终数据，提取修改记录
 * @param {Array} originalData - 初始数据列表
 * @param {Array} finalData - 最终数据列表
 * @returns {Array} 修改记录列表
 */
function compareAndExtractChanges(originalData, finalData) {
    const changes = [];
    
    // 确保两个数组长度一致
    const length = Math.min(originalData.length, finalData.length);
    
    for (let i = 0; i < length; i++) {
        const originalRow = originalData[i];
        const finalRow = finalData[i];
        
        // 确保对比的是同一行（根据id）
        if (originalRow.id !== finalRow.id) {
            console.warn(`第${i+1}行ID不匹配: ${originalRow.id} ≠ ${finalRow.id}`);
            continue;
        }
        
        // 对比每个字段
        ['A', 'B', 'C', 'D', 'E'].forEach(field => {
            const originalValue = originalRow[field] || '';
            const finalValue = finalRow[field] || '';
            
            // 如果值不同，说明字段被修改了
            if (originalValue !== finalValue) {
                changes.push({
                    No: originalRow.id,        // 行ID（数据库中的No）
                    field: field,              // 字段名
                    oldvalue: originalValue,   // 原始值
                    newvalue: finalValue       // 新值
                });
            }
        });
    }
    
    return changes;
}
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">步骤3：对比和提取</div>
            <div class="comparison-summary">
                <p>对比规则：</p>
                <p>1. 按行对比，确保id一致</p>
                <p>2. 对比每个字段（A-E）的值</p>
                <p>3. 只记录值发生变化的字段</p>
                <p>4. 生成符合log表结构的数据</p>
            </div>
            <button class="btn btn-success" onclick="runComparison()">执行对比</button>
        </div>
        
        <div class="result-section" id="resultSection" style="display: none;">
            <div class="result-title">对比结果</div>
            <div class="code-block" id="resultDisplay">
                // 对比结果将显示在这里
            </div>
            <div class="code-block" id="jsonOutput">
                // JSON格式输出
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">实际应用示例</div>
            <p>在实际项目中，你会这样使用：</p>
            <div class="code-block">
// 1. 页面加载时获取初始数据
let originalData = getInitialDataFromBackend();  // 从后端API获取

// 2. 用户编辑表格后获取最终数据
function onSaveButtonClick() {
    const finalData = getCurrentTableData();      // 从表格获取当前数据
    
    // 3. 对比并提取修改记录
    const changeLogs = compareAndExtractChanges(originalData, finalData);
    
    // 4. 发送到后端保存到数据库
    if (changeLogs.length > 0) {
        saveChangeLogsToDatabase(changeLogs);
    }
}

// 从表格获取数据的函数
function getCurrentTableData() {
    const currentData = [];
    $('#dataTable tr').each(function() {
        const $row = $(this);
        const rowId = $row.data('id');  // 假设每行有data-id属性
        
        currentData.push({
            id: rowId,
            A: $row.find('.field-a').val(),
            B: $row.find('.field-b').val(),
            C: $row.find('.field-c').val(),
            D: $row.find('.field-d').val(),
            E: $row.find('.field-e').val()
        });
    });
    return currentData;
}
            </div>
        </div>
    </div>

    <script>
        // 模拟的初始数据
        let originalData = [];
        let finalData = [];
        
        // 生成测试数据
        function generateTestData() {
            // 初始数据
            originalData = [
                { id: 101, A: "数据A1", B: "数据B1", C: "数据C1", D: "数据D1", E: "数据E1" },
                { id: 102, A: "数据A2", B: "数据B2", C: "数据C2", D: "数据D2", E: "数据E2" },
                { id: 103, A: "数据A3", B: "数据B3", C: "数据C3", D: "数据D3", E: "数据E3" }
            ];
            
            // 模拟用户修改后的数据（修改了部分内容）
            finalData = [
                { id: 101, A: "修改后的A1", B: "数据B1", C: "数据C1", D: "数据D1", E: "数据E1" }, // A字段修改
                { id: 102, A: "数据A2", B: "数据B2", C: "新C2值", D: "数据D2", E: "数据E2" },     // C字段修改
                { id: 103, A: "数据A3", B: "新B3数据", C: "数据C3", D: "修改的D3", E: "数据E3" } // B和D字段修改
            ];
            
            // 显示数据
            $('#initialDataDisplay').text(JSON.stringify(originalData, null, 2));
            $('#finalDataDisplay').text(JSON.stringify(finalData, null, 2));
        }
        
        /**
         * 核心函数：对比初始数据和最终数据，提取修改记录
         * @param {Array} originalData - 初始数据列表
         * @param {Array} finalData - 最终数据列表
         * @returns {Array} 修改记录列表
         */
        function compareAndExtractChanges(originalData, finalData) {
            const changes = [];
            
            // 确保两个数组长度一致
            const length = Math.min(originalData.length, finalData.length);
            
            for (let i = 0; i < length; i++) {
                const originalRow = originalData[i];
                const finalRow = finalData[i];
                
                // 确保对比的是同一行（根据id）
                if (originalRow.id !== finalRow.id) {
                    console.warn(`第${i+1}行ID不匹配: ${originalRow.id} ≠ ${finalRow.id}`);
                    continue;
                }
                
                // 对比每个字段
                ['A', 'B', 'C', 'D', 'E'].forEach(field => {
                    const originalValue = originalRow[field] || '';
                    const finalValue = finalRow[field] || '';
                    
                    // 如果值不同，说明字段被修改了
                    if (originalValue !== finalValue) {
                        changes.push({
                            No: originalRow.id,        // 行ID（数据库中的No）
                            field: field,              // 字段名
                            oldvalue: originalValue,   // 原始值
                            newvalue: finalValue       // 新值
                        });
                    }
                });
            }
            
            return changes;
        }
        
        /**
         * 增强版对比函数（处理更多边界情况）
         */
        function compareAndExtractChangesEnhanced(originalData, finalData) {
            const changes = [];
            
            // 创建id到行数据的映射，处理行顺序变化的情况
            const originalMap = new Map();
            originalData.forEach(row => originalMap.set(row.id, row));
            
            const finalMap = new Map();
            finalData.forEach(row => finalMap.set(row.id, row));
            
            // 找出所有在finalData中存在的id（既处理修改，也处理新增）
            const allIds = new Set([
                ...originalData.map(row => row.id),
                ...finalData.map(row => row.id)
            ]);
            
            allIds.forEach(id => {
                const originalRow = originalMap.get(id);
                const finalRow = finalMap.get(id);
                
                // 如果只有finalData中有，说明是新增行（根据你的需求处理）
                if (!originalRow && finalRow) {
                    // 新增行逻辑，如果需要记录新增
                    console.log(`新增行: id=${id}`);
                }
                // 如果只有originalData中有，说明是删除行（根据你的需求处理）
                else if (originalRow && !finalRow) {
                    // 删除行逻辑，如果需要记录删除
                    console.log(`删除行: id=${id}`);
                }
                // 如果两边都有，对比字段
                else if (originalRow && finalRow) {
                    ['A', 'B', 'C', 'D', 'E'].forEach(field => {
                        const originalValue = originalRow[field] || '';
                        const finalValue = finalRow[field] || '';
                        
                        if (originalValue !== finalValue) {
                            changes.push({
                                No: id,
                                field: field,
                                oldvalue: originalValue,
                                newvalue: finalValue
                            });
                        }
                    });
                }
            });
            
            return changes;
        }
        
        // 执行对比
        function runComparison() {
            if (originalData.length === 0) {
                alert('请先生成测试数据');
                return;
            }
            
            // 使用核心函数进行对比
            const changes = compareAndExtractChanges(originalData, finalData);
            
            // 显示结果
            $('#resultSection').show();
            
            if (changes.length === 0) {
                $('#resultDisplay').text('没有发现修改记录');
                $('#jsonOutput').text('[]');
            } else {
                // 格式化显示
                let resultText = `发现 ${changes.length} 处修改:\n\n`;
                changes.forEach((change, index) => {
                    resultText += `${index + 1}. 第${change.No}行的${change.field}字段\n`;
                    resultText += `   旧值: "${change.oldvalue}"\n`;
                    resultText += `   新值: "${change.newvalue}"\n\n`;
                });
                
                $('#resultDisplay').text(resultText);
                $('#jsonOutput').text(JSON.stringify(changes, null, 2));
            }
            
            // 输出到控制台
            console.log('修改记录:', changes);
        }
        
        // 页面加载时生成示例数据
        $(document).ready(function() {
            generateTestData();
        });
    </script>
</body>
</html>